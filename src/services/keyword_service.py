"""
å…³é”®è¯æ‰©å±•æœåŠ¡

æä¾›æ™ºèƒ½å…³é”®è¯æ‰©å±•åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§æ‰©å±•ç­–ç•¥ã€‚
ç”¨äºå®ç°promptè¦æ±‚çš„"æ ¸å¿ƒè¯ â†’ åŒä¹‰è¯ â†’ ç›¸å…³è¯ â†’ ä¸Šä¸‹æ–‡è¯"æ‰©å±•ç­–ç•¥ã€‚
"""

from typing import Dict, List
from ..logger import server_logger


class KeywordService:
    """å…³é”®è¯æ‰©å±•æœåŠ¡ç±»"""
    
    def __init__(self):
        """åˆå§‹åŒ–å…³é”®è¯æ‰©å±•æœåŠ¡"""
        # è´¢åŠ¡ç¨åŠ¡ç›¸å…³æ‰©å±•è¯å…¸
        self.finance_synonyms = {
            "è´¢åŠ¡": ["ä¼šè®¡", "æ ¸ç®—", "è´¦åŠ¡", "èµ„é‡‘", "ç»è´¹", "ç¨å·", "çº³ç¨äºº", "ç¨åŠ¡ç™»è®°"],
            "ç¨åŠ¡": ["ç¨æ”¶", "çº³ç¨", "ç¨æ³•", "ç¨æ”¿", "å¾ç¨", "ç¨å·", "çº³ç¨äººè¯†åˆ«å·"],
            "åˆ¶åº¦": ["è§„å®š", "åŠæ³•", "è§„èŒƒ", "æ ‡å‡†", "æµç¨‹"],
            "æ”¿ç­–": ["æ³•è§„", "æ¡ä¾‹", "è§„ç« ", "é€šçŸ¥", "æ–‡ä»¶"],
            "æµç¨‹": ["ç¨‹åº", "æ­¥éª¤", "æ“ä½œ", "å¤„ç†", "æ‰§è¡Œ"],
            "ç®¡ç†": ["ç›‘ç®¡", "æ§åˆ¶", "æ²»ç†", "è¿è¥", "ç»´æŠ¤"],
            "æŠ¥å‘Š": ["æŠ¥è¡¨", "æ±‡æŠ¥", "æ€»ç»“", "åˆ†æ", "ç»Ÿè®¡"],
            "å®¡è®¡": ["æ£€æŸ¥", "æ ¸æŸ¥", "ç¨½æ ¸", "ç›‘å¯Ÿ", "è¯„ä¼°"],
            "æŠ¥é”€": ["è´¹ç”¨", "æ”¯å‡º", "ç»“ç®—", "æ ¸é”€", "ç”³è¯·"],
            # ç¨å·ç›¸å…³è¯æ±‡åº”è¯¥ä¸»è¦æ‰©å±•ä¸ºè´¢åŠ¡
            "ç¨å·": ["è´¢åŠ¡", "ç¨åŠ¡", "çº³ç¨äººè¯†åˆ«å·", "ç¨åŠ¡ç™»è®°å·", "çº³ç¨äºº", "å‘ç¥¨æŠ¬å¤´"],
            "çº³ç¨äºº": ["è´¢åŠ¡", "ç¨åŠ¡", "ç¨å·", "çº³ç¨äººè¯†åˆ«å·", "ä¼ä¸š", "å‘ç¥¨æŠ¬å¤´"],
            "çº³ç¨äººè¯†åˆ«å·": ["è´¢åŠ¡", "ç¨åŠ¡", "ç¨å·", "çº³ç¨äºº", "ç¨åŠ¡ç™»è®°å·", "å‘ç¥¨æŠ¬å¤´"],
            "ç¨åŠ¡ç™»è®°": ["è´¢åŠ¡", "ç¨åŠ¡", "ç¨å·", "çº³ç¨äºº", "ç™»è®°è¯", "å‘ç¥¨æŠ¬å¤´"],
            "å…¬å¸ç¨å·": ["è´¢åŠ¡", "ç¨åŠ¡", "ä¼ä¸šç®¡ç†", "åˆè§„", "ç”³æŠ¥", "ç™»è®°", "å‘ç¥¨æŠ¬å¤´"]
        }
        
        # æŠ€æœ¯ç›¸å…³æ‰©å±•è¯å…¸
        self.tech_synonyms = {
            "ç³»ç»Ÿ": ["å¹³å°", "è½¯ä»¶", "åº”ç”¨", "å·¥å…·", "ç¨‹åº"],
            "ç½‘ç»œ": ["é€šä¿¡", "è¿æ¥", "ä¼ è¾“", "åè®®", "æ¶æ„"],
            "å®‰å…¨": ["é˜²æŠ¤", "ä¿æŠ¤", "åŠ å¯†", "è®¤è¯", "æƒé™"],
            "æ•°æ®": ["ä¿¡æ¯", "èµ„æ–™", "è®°å½•", "æ¡£æ¡ˆ", "æ–‡æ¡£"],
            "æ ‡å‡†": ["è§„èŒƒ", "å‡†åˆ™", "è¦æ±‚", "æŒ‡æ ‡", "åŸºå‡†"],
            "æŠ€æœ¯": ["å·¥è‰º", "æ–¹æ³•", "æ‰‹æ®µ", "æŠ€èƒ½", "ä¸“ä¸š"],
            "è½¯è‘—": ["è½¯ä»¶è‘—ä½œæƒ", "çŸ¥è¯†äº§æƒ", "ç‰ˆæƒ", "ä¸“åˆ©", "ç™»è®°"]
        }
        
        # äºšä¿¡æ•°å­—äº§å“æœ¯è¯­æ‰©å±•è¯å…¸ - åŸºäºå¸ƒè°·æœ¯è¯­è¡¨
        self.asiainfo_product_synonyms = {
            # OSSå±‚äº§å“æ‰©å±•
            "IPOSS": ["æ™ºæ…§è¿ç»´ç®¡ç†å¹³å°", "ç½‘ç®¡", "NMS", "è¿ç»´ç®¡ç†", "ç½‘ç»œç®¡ç†ç³»ç»Ÿ", "æ™ºèƒ½è¿ç»´", "IPç½‘ç®¡"],
            "NMS": ["ç½‘ç»œç®¡ç†ç³»ç»Ÿ", "IPOSS", "æ™ºæ…§è¿ç»´ç®¡ç†å¹³å°", "ç½‘ç®¡", "æ™ºèƒ½è¿ç»´ç®¡ç†", "IPç½‘ç®¡"],
            "FMS": ["æ•…éšœç®¡ç†ç³»ç»Ÿ", "iNOC", "æ•…éšœç®¡ç†", "è¿ç»´ç³»ç»Ÿ"],
            "iNOC": ["æ™ºèƒ½ç½‘ç»œè¿è¥ä¸­å¿ƒ", "FMS", "æ•…éšœç®¡ç†ç³»ç»Ÿ", "è¿ç»´ä¸­å¿ƒ"],
            "IPAM": ["IPåœ°å€ç®¡ç†ç³»ç»Ÿ", "åœ°å€ç®¡ç†", "ç½‘ç»œç®¡ç†", "IPç®¡ç†"],
            "CNCMP": ["ç®—ç½‘èåˆç®¡ç†å¹³å°", "å¤šäº‘ç®¡ç†å¹³å°", "ç®—åŠ›ç®¡ç†", "äº‘ç®¡ç†"],
            
            # ç»ˆç«¯ç®¡ç†äº§å“æ‰©å±•
            "ITMS": ["ç»¼åˆç»ˆç«¯ç®¡ç†ç³»ç»Ÿ", "ç»ˆç«¯ç®¡ç†", "ACS", "ç»ˆç«¯ç³»ç»Ÿ"],
            "ACS": ["ç»ˆç«¯ç®¡ç†ç³»ç»Ÿ", "ITMS", "ç»ˆç«¯ç®¡ç†", "è®¾å¤‡ç®¡ç†"],
            "CSMP": ["æ™ºæ…§å®¶åº­ç»ˆç«¯èåˆç®¡ç†å¹³å°", "å®¶åº­ç»ˆç«¯", "æ™ºæ…§å®¶åº­", "ç»ˆç«¯èåˆ"],
            "TLMS": ["ç»ˆç«¯å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ç³»ç»Ÿ", "ç»ˆç«¯ç®¡ç†", "ç”Ÿå‘½å‘¨æœŸç®¡ç†"],
            "IoT": ["ç‰©è”ç½‘ç®¡ç†ç³»ç»Ÿ", "ç‰©è”ç½‘", "è®¾å¤‡è”ç½‘", "æ™ºèƒ½è®¾å¤‡"],
            
            # BSSäº§å“æ‰©å±•
            "CBS": ["èåˆè®¡è´¹ç³»ç»Ÿ", "è®¡è´¹ç³»ç»Ÿ", "ç»“ç®—ç³»ç»Ÿ", "è®¡è´¹ç®¡ç†"],
            "CRM": ["å®¢æˆ·å…³ç³»ç®¡ç†ç³»ç»Ÿ", "å®¢æˆ·ç®¡ç†", "å®¢æˆ·æœåŠ¡", "è¥ä¸šå…ç³»ç»Ÿ"],
            "SPN": ["ä¸šåŠ¡å¼€é€šç½‘ç®¡", "ä¸šåŠ¡å¼€é€šç³»ç»Ÿ", "å¼€é€šç®¡ç†", "ä¸šåŠ¡ç®¡ç†"],
            "AAA": ["è®¤è¯æˆæƒè®¡è´¹ç³»ç»Ÿ", "æ¥å…¥è®¤è¯å¹³å°", "è®¤è¯ç³»ç»Ÿ", "æˆæƒç®¡ç†"],
            "Settlement": ["ç»“ç®—ç³»ç»Ÿ", "è®¡è´¹ç»“ç®—", "è´¢åŠ¡ç»“ç®—", "è´¦åŠ¡ç³»ç»Ÿ"],
            "UIP": ["ç»Ÿä¸€äº¤äº’å¹³å°", "äº¤äº’å¹³å°", "ç»Ÿä¸€å¹³å°", "æ¥å£å¹³å°"],
            
            # æ•°æ®åº”ç”¨äº§å“æ‰©å±•
            "CCC": ["å›ºç½‘èåˆæ„ŸçŸ¥åˆ†æå¹³å°", "æµé‡åˆ†æ", "è´¨å·®åˆ†æ", "ç½‘ç»œåˆ†æ"],
            "VAMS": ["è§†é¢‘åº”ç”¨ç®¡ç†ç³»ç»Ÿ", "è§†é¢‘ç®¡ç†", "åº”ç”¨ç®¡ç†", "è§†é¢‘ç³»ç»Ÿ"],
            "FDL": ["æ•°æ®ä¸­å°Lite", "æ•°æ®ä¸­å°", "æ•°æ®å¹³å°", "æ•°æ®ç®¡ç†"],
            
            # VASå¢å€¼æœåŠ¡äº§å“æ‰©å±•
            "SMSC": ["çŸ­ä¿¡ä¸­å¿ƒ", "çŸ­ä¿¡ç³»ç»Ÿ", "æ¶ˆæ¯ä¸­å¿ƒ", "çŸ­ä¿¡æœåŠ¡"],
            "SMS-VAS": ["çŸ­ä¿¡å¢å€¼ä¸šåŠ¡", "çŸ­ä¿¡æœåŠ¡", "å¢å€¼ä¸šåŠ¡", "SMSP", "SMSGW"],
            "USSD": ["éç»“æ„åŒ–è¡¥å……æ•°æ®ä¸šåŠ¡", "è¡¥å……ä¸šåŠ¡", "æ•°æ®ä¸šåŠ¡", "USSDä¸šåŠ¡"],
            "IVR": ["äº¤äº’å¼è¯­éŸ³åº”ç­”ç³»ç»Ÿ", "è¯­éŸ³åº”ç­”", "äº¤äº’è¯­éŸ³", "è¯­éŸ³ç³»ç»Ÿ"],
            "VC": ["å……å€¼ä¸­å¿ƒ", "å……å€¼ç³»ç»Ÿ", "VOMS", "å……å€¼ç®¡ç†"],
            "EIR": ["è®¾å¤‡èº«ä»½å¯„å­˜å™¨", "è®¾å¤‡ç®¡ç†", "èº«ä»½ç®¡ç†", "è®¾å¤‡æ³¨å†Œ"],
            "E-Topup": ["ç”µå­å……å€¼", "å……å€¼æœåŠ¡", "åœ¨çº¿å……å€¼", "å……å€¼ä¸šåŠ¡"],
            "SCP": ["ä¸šåŠ¡æ§åˆ¶ç‚¹", "æ§åˆ¶ç³»ç»Ÿ", "ä¸šåŠ¡æ§åˆ¶", "æœåŠ¡æ§åˆ¶"],
            "DNS": ["åŸŸåç³»ç»Ÿ", "ä¼ä¸šä¸šåŠ¡ç»Ÿè§£æç³»ç»Ÿ", "åŸŸåè§£æ", "DNSæœåŠ¡"],
            
            # æ”¿ä¼äº§å“æ‰©å±•
            "EBOSS": ["ä¼è¥ç›˜", "ä¼è¥èµ¢", "ä¼ä¸šè¿è¥", "æ”¿ä¼å¹³å°"],
            "ä¼è¥ç›˜": ["EBOSS", "ä¼è¥èµ¢", "ä¼ä¸šè¿è¥", "æ”¿ä¼å¹³å°", "ä¼ä¸šç®¡ç†", "è¿è¥ç³»ç»Ÿ"],
            "ä¼è¥èµ¢": ["EBOSS", "ä¼è¥ç›˜", "ä¼ä¸šè¿è¥", "æ”¿ä¼å¹³å°", "ä¼ä¸šç®¡ç†", "è¿è¥ç³»ç»Ÿ"],
            "SSCP": ["æ™ºæ…§ç¯å«äº‘å¹³å°", "ç¯å«ç³»ç»Ÿ", "æ™ºæ…§ç¯å«", "ç¯å«ç®¡ç†"],
            "CEM": ["å®¢æˆ·ä½“éªŒç®¡ç†", "ä½“éªŒç®¡ç†", "å®¢æˆ·æœåŠ¡", "ç”¨æˆ·ä½“éªŒ"],
            
            # ICTåŸºç¡€è®¾æ–½æ‰©å±•
            "DHCP": ["åŠ¨æ€ä¸»æœºé…ç½®åè®®", "åœ°å€åˆ†é…", "ç½‘ç»œé…ç½®", "IPåˆ†é…"],
            
            # ç¼ºå¤±çš„äº§å“è¡¥å……
            "èƒ½åŠ›æµ‹åº¦ç³»ç»Ÿ": ["èƒ½åŠ›è¯„ä¼°", "æ€§èƒ½æµ‹é‡", "ç³»ç»Ÿè¯„ä¼°", "èƒ½åŠ›åˆ†æ"],
            "æµé‡åˆ†æç³»ç»Ÿ": ["CCC", "ç½‘ç»œåˆ†æ", "æ•°æ®åˆ†æ", "æµé‡ç›‘æ§", "è´¨å·®åˆ†æ"],
            "AIå®¢æœé—®ç­”ç³»ç»Ÿ": ["æ™ºèƒ½å®¢æœ", "é—®ç­”ç³»ç»Ÿ", "äººå·¥æ™ºèƒ½", "å®¢æœæœºå™¨äºº"],
            "æ™ºæ…§å·¥åœ°äº‘ç›‘å·¥å¹³å°": ["å·¥åœ°ç®¡ç†", "æ–½å·¥ç›‘æ§", "äº‘ç›‘å·¥", "æ™ºæ…§å»ºç­‘"],
            "æ ¡å›­AAAç³»ç»Ÿ": ["æ ¡å›­ç½‘è®¤è¯", "AAA", "æ•™è‚²ç½‘ç»œ", "å­¦æ ¡è®¤è¯", "æ ¡å›­ç®¡ç†"],
            "å«æ˜Ÿç»ˆç«¯ç®¡ç†APP": ["å«æ˜Ÿé€šä¿¡", "ç»ˆç«¯ç®¡ç†", "ç§»åŠ¨åº”ç”¨", "å«æ˜Ÿè®¾å¤‡"],
            "æ”¿ä¼ä¸šåŠ¡ç»¼åˆè¿ç»´å¹³å°": ["æ”¿ä¼è¿ç»´", "ç»¼åˆå¹³å°", "ä¸šåŠ¡è¿ç»´", "ä¼ä¸šæœåŠ¡"],
            "æ”¿ä¼ä¸“çº¿å®¢æœ": ["ä¸“çº¿æœåŠ¡", "æ”¿ä¼å®¢æœ", "ä¸“çº¿æ”¯æŒ", "ä¼ä¸šå®¢æœ"],
            "RMS": ["ITMS", "è¿œç¨‹ç®¡ç†", "ç»ˆç«¯ç®¡ç†", "è®¾å¤‡ç®¡ç†"],
            "PCDN": ["CCC", "å†…å®¹åˆ†å‘", "ç½‘ç»œåŠ é€Ÿ", "CDNæœåŠ¡"],
            
            # ç‰¹æ®Šäº§å“ç®€ç§°æ‰©å±•
            "ç½‘ç®¡": ["NMS", "IPOSS", "æ™ºæ…§è¿ç»´ç®¡ç†å¹³å°", "ç½‘ç»œç®¡ç†", "è¿ç»´ç®¡ç†"],
            "è¿ç»´": ["IPOSS", "è¿ç»´ç®¡ç†", "ç½‘ç»œè¿ç»´", "ç³»ç»Ÿè¿ç»´", "æ™ºèƒ½è¿ç»´"],
            "ç»ˆç«¯": ["ITMS", "ç»ˆç«¯ç®¡ç†", "è®¾å¤‡ç®¡ç†", "ç»ˆç«¯ç³»ç»Ÿ"],
            "è®¡è´¹": ["CBS", "è®¡è´¹ç³»ç»Ÿ", "ç»“ç®—ç³»ç»Ÿ", "è´¢åŠ¡ç³»ç»Ÿ"],
            "å®¢æœ": ["CRM", "å®¢æˆ·æœåŠ¡", "å®¢æˆ·ç®¡ç†", "æœåŠ¡ç³»ç»Ÿ"]
        }
        
        # ä¸šåŠ¡åœºæ™¯ç›¸å…³è¯å…¸
        self.business_contexts = {
            "è´¢åŠ¡": ["é¢„ç®—", "æˆæœ¬", "æ”¶å…¥", "æ”¯å‡º", "åˆ©æ¶¦", "èµ„äº§", "ç¨å·", "çº³ç¨äºº"],
            "ç¨åŠ¡": ["å‘ç¥¨", "ç”³æŠ¥", "ç¼´çº³", "å‡å…", "ä¼˜æƒ ", "åˆè§„", "ç¨å·", "çº³ç¨äººè¯†åˆ«å·"],
            "åˆ¶åº¦": ["æ‰§è¡Œ", "ç›‘ç£", "è€ƒæ ¸", "åŸ¹è®­", "å®£è´¯", "æ›´æ–°"],
            "ç³»ç»Ÿ": ["éƒ¨ç½²", "é…ç½®", "ç»´æŠ¤", "å‡çº§", "ç›‘æ§", "å¤‡ä»½"],
            "ç½‘ç»œ": ["å¸¦å®½", "å»¶è¿Ÿ", "ç¨³å®š", "æ•…éšœ", "ä¼˜åŒ–", "æ‰©å®¹"],
            "æŠ¥é”€": ["æµç¨‹", "å®¡æ‰¹", "å‘ç¥¨", "å‡­è¯", "æ ‡å‡†", "æ”¿ç­–"],
            "è½¯è‘—": ["ç”³è¯·", "ææ–™", "æµç¨‹", "è´¹ç”¨", "æƒåˆ©", "ä¿æŠ¤"],
            # ç¨å·ç›¸å…³çš„ä¸šåŠ¡åœºæ™¯è¯æ±‡
            "ç¨å·": ["è´¢åŠ¡", "ç¨åŠ¡", "ç™»è®°", "ç”³æŠ¥", "åˆè§„", "ç®¡ç†", "å‘ç¥¨æŠ¬å¤´"],
            "çº³ç¨äºº": ["è´¢åŠ¡", "ç¨åŠ¡", "ä¼ä¸š", "ç™»è®°", "ç”³æŠ¥", "ä¹‰åŠ¡", "å‘ç¥¨æŠ¬å¤´"],
            "å…¬å¸ç¨å·": ["è´¢åŠ¡", "ç¨åŠ¡", "ä¼ä¸šç®¡ç†", "åˆè§„", "ç”³æŠ¥", "ç™»è®°", "å‘ç¥¨æŠ¬å¤´"],
            # æ–°å¢äº§å“ç›¸å…³ä¸šåŠ¡åœºæ™¯
            "IPOSS": ["è¿ç»´", "ç›‘æ§", "ç½‘ç»œ", "æ•…éšœ", "æ€§èƒ½", "é…ç½®", "ç®¡ç†", "å‘Šè­¦"],
            "NMS": ["ç½‘ç»œ", "ç®¡ç†", "ç›‘æ§", "è¿ç»´", "æ•…éšœ", "æ€§èƒ½", "é…ç½®"],
            "ITMS": ["ç»ˆç«¯", "è®¾å¤‡", "ç®¡ç†", "é…ç½®", "ç›‘æ§", "å‡çº§", "ç»´æŠ¤"],
            "CBS": ["è®¡è´¹", "ç»“ç®—", "è´¢åŠ¡", "è´¦åŠ¡", "æ”¶è´¹", "ç®¡ç†", "ç³»ç»Ÿ"],
            "CRM": ["å®¢æˆ·", "æœåŠ¡", "ç®¡ç†", "è¥é”€", "é”€å”®", "å…³ç³»", "ç»´æŠ¤"],
            "EBOSS": ["ä¼ä¸š", "è¿è¥", "ç®¡ç†", "å¹³å°", "ç³»ç»Ÿ", "ä¸šåŠ¡", "æµç¨‹"],
            "è¿ç»´": ["ç›‘æ§", "ç»´æŠ¤", "æ•…éšœ", "æ€§èƒ½", "å¤‡ä»½", "å‡çº§", "ä¼˜åŒ–", "å®‰å…¨"],
            "ç½‘ç®¡": ["ç½‘ç»œ", "ç®¡ç†", "ç›‘æ§", "é…ç½®", "æ•…éšœ", "æ€§èƒ½", "è¿ç»´"],
            "ç»ˆç«¯": ["è®¾å¤‡", "ç®¡ç†", "é…ç½®", "ç›‘æ§", "ç»´æŠ¤", "å‡çº§", "å®‰å…¨"],
            "è®¡è´¹": ["ç»“ç®—", "æ”¶è´¹", "è´¦åŠ¡", "è´¢åŠ¡", "ç®¡ç†", "ç³»ç»Ÿ", "ä¸šåŠ¡"],
            # æ–°å¢äº§å“çš„ä¸šåŠ¡åœºæ™¯
            "èƒ½åŠ›æµ‹åº¦ç³»ç»Ÿ": ["æ€§èƒ½", "è¯„ä¼°", "åˆ†æ", "æµ‹é‡", "ç›‘æ§", "ä¼˜åŒ–", "æŒ‡æ ‡"],
            "æµé‡åˆ†æç³»ç»Ÿ": ["æµé‡", "åˆ†æ", "ç›‘æ§", "ç»Ÿè®¡", "ä¼˜åŒ–", "è´¨é‡", "æ€§èƒ½"],
            "AIå®¢æœé—®ç­”ç³»ç»Ÿ": ["å®¢æœ", "æ™ºèƒ½", "é—®ç­”", "æœåŠ¡", "è‡ªåŠ¨åŒ–", "æœºå™¨äºº", "äº¤äº’"],
            "æ™ºæ…§å·¥åœ°äº‘ç›‘å·¥å¹³å°": ["å·¥åœ°", "ç›‘æ§", "ç®¡ç†", "å®‰å…¨", "è´¨é‡", "è¿›åº¦", "æ™ºèƒ½"],
            "æ ¡å›­AAAç³»ç»Ÿ": ["æ ¡å›­", "è®¤è¯", "æˆæƒ", "ç½‘ç»œ", "å­¦æ ¡", "æ•™è‚²", "ç®¡ç†"],
            "å«æ˜Ÿç»ˆç«¯ç®¡ç†APP": ["å«æ˜Ÿ", "ç»ˆç«¯", "ç®¡ç†", "é€šä¿¡", "ç§»åŠ¨", "è®¾å¤‡", "æ§åˆ¶"],
            "æ”¿ä¼ä¸šåŠ¡ç»¼åˆè¿ç»´å¹³å°": ["æ”¿ä¼", "è¿ç»´", "ä¸šåŠ¡", "ç»¼åˆ", "å¹³å°", "æœåŠ¡", "ç®¡ç†"],
            "æ”¿ä¼ä¸“çº¿å®¢æœ": ["æ”¿ä¼", "ä¸“çº¿", "å®¢æœ", "æœåŠ¡", "æ”¯æŒ", "ä¼ä¸š", "é€šä¿¡"],
            "RMS": ["è¿œç¨‹", "ç®¡ç†", "ç»ˆç«¯", "è®¾å¤‡", "æ§åˆ¶", "ç›‘æ§", "ç»´æŠ¤"],
            "PCDN": ["å†…å®¹", "åˆ†å‘", "åŠ é€Ÿ", "ç½‘ç»œ", "CDN", "æœåŠ¡", "ä¼˜åŒ–"]
        }
        
        # ä¸šåŠ¡é¢†åŸŸè¯†åˆ«è¯å…¸ - åŸºäºç”¨æˆ·æä¾›çš„åœºæ™¯åˆ†ç±»è¿›è¡Œæ›´æ–°
        self.domain_keywords = {
            "äºšä¿¡ä¼ä¸šå†…éƒ¨äº‹åŠ¡": {
                "è§¦å‘è¯": [
                    # æ³•åŠ¡ç±»
                    "åˆåŒ", "å®¡æ ¸", "çŸ¥è¯†äº§æƒ", "æ³•å¾‹", "å’¨è¯¢", "æ³•åŠ¡",
                    # è´¢åŠ¡ç±»
                    "æŠ¥é”€", "æµç¨‹", "é¢„ç®—", "ç®¡ç†", "è´¢åŠ¡", "åˆ¶åº¦", "ç¨å·", "çº³ç¨äºº", "ç¨åŠ¡ç™»è®°", "çº³ç¨äººè¯†åˆ«å·",
                    # äººäº‹ç±»
                    "æ‹›è˜", "å…¥èŒ", "è€ƒå‹¤", "ä¼‘å‡", "åŸ¹è®­", "å‘å±•", "äººäº‹", "å‘˜å·¥", "è–ªèµ„", "ç»©æ•ˆ",
                    # è¡Œæ”¿ç±»
                    "åŠå…¬", "è®¾æ–½", "åå‹¤", "ä¿éšœ", "ä¼šè®®", "ç®¡ç†", "è¡Œæ”¿", "é‡‡è´­", "èµ„äº§", "è®¾å¤‡",
                    # è¡¥è´´ç±»
                    "è¡¥è´´", "ç”³è¯·", "å‘æ”¾", "æ ‡å‡†", "ç»“ç®—", "å‘¨æœŸ",
                    # ä¼è¥èµ¢/EBOSSç±»
                    "ä¼è¥èµ¢", "EBOSS", "ç³»ç»Ÿ", "å¹³å°",
                    # è½¯è‘—ç±»
                    "è½¯è‘—", "è½¯ä»¶è‘—ä½œæƒ", "ç‰ˆæƒ", "ä¸“åˆ©"
                ],
                "æ‰©å±•è¯": ["åˆ¶åº¦", "æµç¨‹", "å®¡æ‰¹", "ç®¡ç†", "æ”¿ç­–", "è§„èŒƒ", "æ ‡å‡†", "ç›‘ç£", "åˆè§„", "å†…æ§"],
                "ä¼˜å…ˆçº§": ["åˆ¶åº¦", "æµç¨‹", "å®¡æ‰¹", "ç®¡ç†"]
            },
            "è¿è¥å•†äº§å“è§£å†³æ–¹æ¡ˆ": {
                "è§¦å‘è¯": [
                    # OSSå±‚äº§å“
                    "IPOSS", "NMS", "FMS", "iNOC", "IPAM", "CNCMP",
                    "æ™ºæ…§è¿ç»´", "ç½‘ç»œç®¡ç†", "æ•…éšœç®¡ç†", "ç®—ç½‘èåˆ", "IPç½‘ç®¡",
                    # ç»ˆç«¯ç®¡ç†äº§å“
                    "ITMS", "ACS", "CSMP", "TLMS", "IoT", 
                    "ç»ˆç«¯ç®¡ç†", "æ™ºæ…§å®¶åº­", "ç‰©è”ç½‘",
                    # æ•°æ®åº”ç”¨äº§å“
                    "CCC", "VAMS", "FDL", "æµé‡åˆ†æ", "è§†é¢‘åº”ç”¨", "æ•°æ®ä¸­å°",
                    # ICTåŸºç¡€è®¾æ–½
                    "DNS", "IVR", "AAA", "åŸŸåç³»ç»Ÿ", "è¯­éŸ³åº”ç­”"
                ],
                "æ‰©å±•è¯": ["è¿ç»´", "ç½‘ç»œ", "ç³»ç»Ÿ", "å¹³å°", "ç®¡ç†", "ç›‘æ§", "é…ç½®", "æ•…éšœ", "æ€§èƒ½", "æŠ€æœ¯"],
                "ä¼˜å…ˆçº§": ["è¿ç»´", "ç½‘ç»œ", "ç³»ç»Ÿ", "ç®¡ç†"]
            },
            "æ”¿ä¼äº§å“è§£å†³æ–¹æ¡ˆ": {
                "è§¦å‘è¯": [
                    "EBOSS", "SSCP", "ä¼è¥ç›˜", "æ™ºæ…§ç¯å«", 
                    "æ™ºæ…§å·¥åœ°", "æ ¡å›­AAA", "æ”¿ä¼ä¸“çº¿", "å«æ˜Ÿç»ˆç«¯",
                    "æ”¿ä¼ä¸šåŠ¡", "ç»¼åˆè¿ç»´", "äº‘ç›‘å·¥"
                ],
                "æ‰©å±•è¯": ["æ”¿ä¼", "æ™ºæ…§", "äº‘å¹³å°", "ç®¡ç†", "ç›‘æ§", "ä¸šåŠ¡", "ç³»ç»Ÿ", "æœåŠ¡"],
                "ä¼˜å…ˆçº§": ["æ”¿ä¼", "æ™ºæ…§", "ç®¡ç†", "ç³»ç»Ÿ"]
            },
            "å›½é™…äº§å“BSSè§£å†³æ–¹æ¡ˆ": {
                "è§¦å‘è¯": [
                    # BSSç±»äº§å“
                    "CBS", "CRM", "SPN", "Settlement", "UIP",
                    "èåˆè®¡è´¹", "å®¢æˆ·å…³ç³»ç®¡ç†", "ä¸šåŠ¡å¼€é€š", "ç»“ç®—ç³»ç»Ÿ", "ç»Ÿä¸€äº¤äº’",
                    # VASå¢å€¼æœåŠ¡
                    "SMSC", "SMS-VAS", "USSD", "IVR", "VC", "EIR", 
                    "E-Topup", "SCP", "çŸ­ä¿¡ä¸­å¿ƒ", "å……å€¼ä¸­å¿ƒ"
                ],
                "æ‰©å±•è¯": ["è®¡è´¹", "å®¢æˆ·", "ä¸šåŠ¡", "ç»“ç®—", "ç®¡ç†", "ç³»ç»Ÿ", "æœåŠ¡", "å¹³å°"],
                "ä¼˜å…ˆçº§": ["è®¡è´¹", "å®¢æˆ·", "ä¸šåŠ¡", "ç³»ç»Ÿ"]
            },
            "å›½é™…äº§å“OSSè§£å†³æ–¹æ¡ˆ": {
                "è§¦å‘è¯": [
                    "NMS", "iNOC", "CEM", "CNCMP", "ACS",
                    "ç½‘ç»œç®¡ç†", "æ™ºèƒ½ç½‘ç»œè¿è¥", "å®¢æˆ·ä½“éªŒç®¡ç†", 
                    "è®¡ç®—ç½‘ç»œèåˆ", "ç»ˆç«¯ç®¡ç†ç³»ç»Ÿ"
                ],
                "æ‰©å±•è¯": ["ç½‘ç»œ", "è¿ç»´", "ç®¡ç†", "ç›‘æ§", "ç³»ç»Ÿ", "å¹³å°", "æœåŠ¡", "æŠ€æœ¯"],
                "ä¼˜å…ˆçº§": ["ç½‘ç»œ", "è¿ç»´", "ç®¡ç†", "ç³»ç»Ÿ"]
            },
            "ç¨åŠ¡æ”¿ç­–é—®é¢˜": {
                "è§¦å‘è¯": [
                    # ç¨ç‡æŸ¥è¯¢ç›¸å…³
                    "ç¨ç‡", "æ˜¯å¤šå°‘", "å‡ ä¸ªç‚¹", "ç™¾åˆ†ä¹‹å‡ ", 
                    "é¢„ææ‰€å¾—ç¨", "ä¼ä¸šæ‰€å¾—ç¨", "ä¸ªäººæ‰€å¾—ç¨", "å¢å€¼ç¨",
                    "ç¨åŠ¡", "ç¨æ”¶", "çº³ç¨", "ç¨æ³•", "ç¨å·", "çº³ç¨äºº", "çº³ç¨äººè¯†åˆ«å·"
                ],
                "æ‰©å±•è¯": ["è´¢åŠ¡", "ç¨åŠ¡", "æ”¿ç­–", "æ³•è§„", "ç¨ç‡", "ç”³æŠ¥", "ç¼´çº³", "åˆè§„", "å‘ç¥¨", "å‘ç¥¨æŠ¬å¤´"],
                "ä¼˜å…ˆçº§": ["è´¢åŠ¡", "ç¨åŠ¡", "æ”¿ç­–", "ç¨ç‡"]
            },
            "è½¯è‘—ç›¸å…³é—®é¢˜": {
                "è§¦å‘è¯": [
                    "è½¯è‘—", "è½¯ä»¶è‘—ä½œæƒ", "ç‰ˆæƒ", "çŸ¥è¯†äº§æƒ", "ä¸“åˆ©",
                    "ç”³è¯·", "ææ–™", "æ—¶é—´", "è´¹ç”¨", "æµç¨‹",
                    "æƒåˆ©", "ä¿æŠ¤", "ä¾µæƒ", "ç»´æƒ",
                    "ç™»è®°", "å˜æ›´", "ç»­å±•", "è¯ä¹¦", "è¡¥åŠ"
                ],
                "æ‰©å±•è¯": ["è½¯è‘—", "çŸ¥è¯†äº§æƒ", "ç”³è¯·", "æµç¨‹", "ææ–™", "è´¹ç”¨", "ä¿æŠ¤", "æƒåˆ©", "æ³•è§„"],
                "ä¼˜å…ˆçº§": ["è½¯è‘—", "çŸ¥è¯†äº§æƒ", "ç”³è¯·", "æµç¨‹"]
            },
            # ä¿ç•™åŸæœ‰çš„å…¶ä»–ä¸šåŠ¡é¢†åŸŸï¼Œä»¥å…¼å®¹ç°æœ‰åŠŸèƒ½
            "å·®æ—…å‡ºè¡Œ": {
                "è§¦å‘è¯": ["å‡ºå·®", "å·®æ—…", "é…’åº—", "æœºç¥¨", "ç«è½¦", "é«˜é“", "ä½å®¿", "äº¤é€š", "è·¯è´¹", "é¤è´¹"],
                "æ‰©å±•è¯": ["è´¢åŠ¡", "è¡Œæ”¿", "æŠ¥é”€", "è´¹ç”¨", "æ ‡å‡†", "å®¡æ‰¹", "å‘ç¥¨", "å‡­è¯", "é¢„ç®—", "æˆæœ¬æ§åˆ¶"],
                "ä¼˜å…ˆçº§": ["è´¢åŠ¡", "è¡Œæ”¿", "æŠ¥é”€", "è´¹ç”¨"]
            },
            "è´¢åŠ¡ç®¡ç†": {
                "è§¦å‘è¯": ["è´¢åŠ¡", "ä¼šè®¡", "æˆæœ¬", "é¢„ç®—", "æŠ¥é”€", "å‘ç¥¨", "ç¨åŠ¡", "å®¡è®¡", "ç¨å·", "çº³ç¨äºº", "çº³ç¨äººè¯†åˆ«å·"],
                "æ‰©å±•è¯": ["åˆ¶åº¦", "æµç¨‹", "å®¡æ‰¹", "æ ¸ç®—", "ç›‘ç®¡", "åˆè§„", "é£é™©", "å†…æ§"],
                "ä¼˜å…ˆçº§": ["åˆ¶åº¦", "æµç¨‹", "å®¡æ‰¹", "åˆè§„"]
            },
            "æŠ€æœ¯è¿ç»´": {
                "è§¦å‘è¯": ["ç³»ç»Ÿ", "ç½‘ç»œ", "æœåŠ¡å™¨", "æ•°æ®åº“", "ç›‘æ§", "è¿ç»´", "æ•…éšœ", "æ€§èƒ½", "IPOSS"],
                "æ‰©å±•è¯": ["æŠ€æœ¯", "æ ‡å‡†", "è§„èŒƒ", "æµç¨‹", "å®‰å…¨", "å¤‡ä»½", "å‡çº§", "ä¼˜åŒ–"],
                "ä¼˜å…ˆçº§": ["æŠ€æœ¯", "æ ‡å‡†", "è§„èŒƒ", "æµç¨‹"]
            }
        }
        
        # äºšä¿¡æ•°å­—ä¸šåŠ¡ç‰¹è‰²ä¸Šä¸‹æ–‡è¯ - åŸºäºäº§å“æœ¯è¯­è¡¨æ‰©å±•
        self.asiainfo_contexts = [
            "äºšä¿¡æ•°å­—", "å…¬å¸", "å‘˜å·¥", "éƒ¨é—¨", "é¡¹ç›®", "å®¢æˆ·",
            "åˆè§„", "é£é™©", "å†…æ§", "å®¡æ‰¹", "æµç¨‹", "æ ‡å‡†",
            # è¿è¥å•†äº§å“ç›¸å…³
            "IPOSS", "ç½‘ç»œç®¡ç†", "è¿ç»´", "ç›‘æ§", "å‘Šè­¦", "æ€§èƒ½",
            "æ™ºæ…§è¿ç»´", "æ•…éšœç®¡ç†", "ç»ˆç«¯ç®¡ç†", "ç®—ç½‘èåˆ",
            # å›½é™…äº§å“ç›¸å…³
            "CBS", "CRM", "è®¡è´¹ç³»ç»Ÿ", "å®¢æˆ·ç®¡ç†", "ä¸šåŠ¡å¼€é€š",
            "NMS", "iNOC", "ç½‘ç»œè¿è¥ä¸­å¿ƒ", "å®¢æˆ·ä½“éªŒ",
            # æ”¿ä¼äº§å“ç›¸å…³
            "ä¼è¥èµ¢", "EBOSS", "æ™ºæ…§ç¯å«", "æ”¿ä¼ä¸šåŠ¡",
            # æŠ€æœ¯å’ŒçŸ¥è¯†äº§æƒ
            "è½¯è‘—", "çŸ¥è¯†äº§æƒ", "æ•°æ®ä¸­å°", "ç‰©è”ç½‘", "äº‘å¹³å°"
        ]
        
        # å¸ƒè°·ä¸“ç”¨æ‰©å±•è¯å…¸ - å¢åŠ äº§å“æœ¯è¯­å…³è”
        self.cuckoo_synonyms = {
            "å¸ƒè°·": ["é€šç”¨çŸ¥è¯†", "äºšä¿¡æ•°å­—é€šç”¨", "äºšä¿¡åˆ›æ–°é€šç”¨", "äº§å“æœ¯è¯­", "æŠ€æœ¯è¯æ±‡"]
        }
        
        # ç›¸ä¼¼è¯æ˜ å°„æ‰©å±• - å¢åŠ äº§å“æœ¯è¯­ç›¸å…³çš„ç›¸ä¼¼è¯åŒ¹é…
        self.product_similarity_map = {
            # äº§å“åˆ«åå’Œæµ·å¤–ç‰ˆæœ¬æ˜ å°„
            "IPOSS": ["NMS", "æ™ºæ…§è¿ç»´", "ç½‘ç»œç®¡ç†", "è¿ç»´ç®¡ç†", "IPç½‘ç®¡"],
            "NMS": ["IPOSS", "ç½‘ç»œç®¡ç†ç³»ç»Ÿ", "æ™ºæ…§è¿ç»´ç®¡ç†å¹³å°", "IPç½‘ç®¡"],
            "ITMS": ["ACS", "ç»ˆç«¯ç®¡ç†ç³»ç»Ÿ", "ç»¼åˆç»ˆç«¯ç®¡ç†"],
            "ACS": ["ITMS", "ç»ˆç«¯ç®¡ç†", "è®¾å¤‡ç®¡ç†"],
            "FMS": ["iNOC", "æ•…éšœç®¡ç†", "æ™ºèƒ½ç½‘ç»œè¿è¥"],
            "iNOC": ["FMS", "æ•…éšœç®¡ç†ç³»ç»Ÿ", "è¿ç»´ä¸­å¿ƒ"],
            "EBOSS": ["ä¼è¥ç›˜", "ä¼è¥èµ¢", "æ”¿ä¼å¹³å°"],
            "ä¼è¥ç›˜": ["EBOSS", "ä¼è¥èµ¢", "ä¼ä¸šè¿è¥", "æ”¿ä¼å¹³å°"],
            "ä¼è¥èµ¢": ["EBOSS", "ä¼è¥ç›˜", "ä¼ä¸šè¿è¥", "æ”¿ä¼å¹³å°"],
            "è¿ç»´": ["ç½‘ç®¡", "ç›‘æ§", "ç»´æŠ¤", "ç®¡ç†"],
            "ç½‘ç®¡": ["è¿ç»´", "NMS", "IPOSS", "ç½‘ç»œç®¡ç†", "IPç½‘ç®¡"],
            "ç»ˆç«¯": ["è®¾å¤‡", "ITMS", "ACS", "ç»ˆç«¯ç®¡ç†"],
            "è®¡è´¹": ["CBS", "ç»“ç®—", "è´¢åŠ¡", "æ”¶è´¹"],
            # æ–°å¢äº§å“ç›¸ä¼¼è¯æ˜ å°„
            "æµé‡åˆ†æç³»ç»Ÿ": ["CCC", "ç½‘ç»œåˆ†æ", "æ•°æ®åˆ†æ", "æµé‡ç›‘æ§"],
            "AIå®¢æœé—®ç­”ç³»ç»Ÿ": ["æ™ºèƒ½å®¢æœ", "å®¢æœç³»ç»Ÿ", "é—®ç­”æœºå™¨äºº"],
            "æ ¡å›­AAAç³»ç»Ÿ": ["æ ¡å›­è®¤è¯", "æ•™è‚²ç½‘ç»œ", "å­¦æ ¡ç½‘ç»œ"],
            "RMS": ["ITMS", "è¿œç¨‹ç®¡ç†", "ç»ˆç«¯ç³»ç»Ÿ"],
            "PCDN": ["CCC", "CDN", "å†…å®¹åˆ†å‘"]
        }
        
        # åˆå¹¶æ‰€æœ‰åŒä¹‰è¯è¯å…¸
        self.all_synonyms = {**self.finance_synonyms, **self.tech_synonyms, **self.asiainfo_product_synonyms, **self.cuckoo_synonyms}
    
    def _identify_business_domains(self, query: str) -> List[str]:
        """
        æ™ºèƒ½è¯†åˆ«æŸ¥è¯¢å†…å®¹çš„ä¸šåŠ¡é¢†åŸŸ
        
        Args:
            query: æŸ¥è¯¢å†…å®¹
            
        Returns:
            åŒ¹é…çš„ä¸šåŠ¡é¢†åŸŸåˆ—è¡¨
        """
        query_lower = query.lower()
        matched_domains = []
        
        # å®šä¹‰ä¼˜å…ˆçº§é¡ºåºï¼šäº§å“ç›¸å…³é¢†åŸŸä¼˜å…ˆäºé€šç”¨æŠ€æœ¯é¢†åŸŸ
        domain_priority = [
            "è¿è¥å•†äº§å“è§£å†³æ–¹æ¡ˆ",
            "æ”¿ä¼äº§å“è§£å†³æ–¹æ¡ˆ", 
            "å›½é™…äº§å“BSSè§£å†³æ–¹æ¡ˆ",
            "å›½é™…äº§å“OSSè§£å†³æ–¹æ¡ˆ",
            "äºšä¿¡ä¼ä¸šå†…éƒ¨äº‹åŠ¡",
            "ç¨åŠ¡æ”¿ç­–é—®é¢˜",
            "è½¯è‘—ç›¸å…³é—®é¢˜",
            "å·®æ—…å‡ºè¡Œ",
            "è´¢åŠ¡ç®¡ç†",
            "æŠ€æœ¯è¿ç»´"  # æœ€ååŒ¹é…é€šç”¨æŠ€æœ¯é¢†åŸŸ
        ]
        
        # æŒ‰ä¼˜å…ˆçº§é¡ºåºæ£€æŸ¥åŒ¹é…
        for domain in domain_priority:
            if domain not in self.domain_keywords:
                continue
                
            keywords = self.domain_keywords[domain]
            trigger_words = keywords["è§¦å‘è¯"]
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«è§¦å‘è¯ï¼ˆæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰
            for trigger in trigger_words:
                if trigger in query_lower:
                    matched_domains.append(domain)
                    server_logger.info(f"è¯†åˆ«åˆ°ä¸šåŠ¡é¢†åŸŸ: {domain} (è§¦å‘è¯: {trigger})")
                    return matched_domains  # æ‰¾åˆ°é«˜ä¼˜å…ˆçº§åŒ¹é…å°±è¿”å›
                # å¢åŠ ç›¸ä¼¼è¯åŒ¹é…é€»è¾‘
                elif self._is_similar_word(trigger, query_lower):
                    matched_domains.append(domain)
                    server_logger.info(f"è¯†åˆ«åˆ°ä¸šåŠ¡é¢†åŸŸ: {domain} (ç›¸ä¼¼è¯åŒ¹é…: {trigger})")
                    return matched_domains  # æ‰¾åˆ°é«˜ä¼˜å…ˆçº§åŒ¹é…å°±è¿”å›
        
        return matched_domains
    
    def _is_similar_word(self, word: str, query: str) -> bool:
        """
        æ£€æŸ¥è¯æ±‡ç›¸ä¼¼æ€§
        
        Args:
            word: è¯å…¸ä¸­çš„è¯æ±‡
            query: æŸ¥è¯¢å†…å®¹
            
        Returns:
            æ˜¯å¦ç›¸ä¼¼
        """
        # è´¢åŠ¡ç¨åŠ¡ç›¸å…³çš„ç›¸ä¼¼è¯åŒ¹é… - é‡ç‚¹å¢å¼ºç¨å·ã€çº³ç¨äººçš„è´¢åŠ¡å…³è”
        similarity_map = {
            "ç¨åŠ¡": ["ç¨æ”¶", "çº³ç¨", "å¾ç¨", "ç¨æ³•", "ç¨å·", "çº³ç¨äºº", "çº³ç¨äººè¯†åˆ«å·"],
            "è´¢åŠ¡": ["è´¢æ”¿", "èµ„é‡‘", "é‡‘è", "ç¨å·", "çº³ç¨äºº", "ç¨åŠ¡ç™»è®°", "çº³ç¨äººè¯†åˆ«å·"],
            "åˆ¶åº¦": ["æ”¿ç­–", "è§„å®š", "æ³•è§„"],
            "ç®¡ç†": ["ç›‘ç®¡", "æ²»ç†", "æ§åˆ¶"],
            "å®¡è®¡": ["å®¡æ ¸", "æ ¸æŸ¥", "æ£€æŸ¥"],
            "æ”¿ç­–": ["åˆ¶åº¦", "è§„å®š", "åŠæ³•"],
            "ç¨å·": ["çº³ç¨äººè¯†åˆ«å·", "ç¨åŠ¡ç™»è®°å·", "è´¢åŠ¡", "ç¨åŠ¡", "çº³ç¨äºº"],
            "çº³ç¨äºº": ["ç¨å·", "çº³ç¨äººè¯†åˆ«å·", "è´¢åŠ¡", "ç¨åŠ¡", "ä¼ä¸š", "ç¨åŠ¡ç™»è®°"],
            "çº³ç¨äººè¯†åˆ«å·": ["ç¨å·", "çº³ç¨äºº", "è´¢åŠ¡", "ç¨åŠ¡", "ç¨åŠ¡ç™»è®°å·"],
            "è½¯è‘—": ["è½¯ä»¶è‘—ä½œæƒ", "ç‰ˆæƒ", "çŸ¥è¯†äº§æƒ", "ä¸“åˆ©"],
            "æŠ¥é”€": ["è´¹ç”¨", "æ”¯å‡º", "è´¢åŠ¡", "ç”³è¯·", "å®¡æ‰¹", "æµç¨‹"]
        }
        
        # åˆå¹¶äº§å“æœ¯è¯­ç›¸ä¼¼è¯æ˜ å°„
        combined_similarity_map = {**similarity_map, **self.product_similarity_map}
        
        if word in combined_similarity_map:
            for similar in combined_similarity_map[word]:
                if similar in query:
                    return True
        
        # åå‘åŒ¹é…ï¼šå¦‚æœæŸ¥è¯¢è¯åœ¨ç›¸ä¼¼è¯åˆ—è¡¨ä¸­ï¼ŒåŒ¹é…å¯¹åº”çš„ä¸»è¯
        for key, similar_words in combined_similarity_map.items():
            if word == key and any(similar in query for similar in similar_words):
                return True
        
        return False
    
    def _generate_dynamic_context_words(self, query: str, domains: List[str], synonyms: set) -> List[str]:
        """
        æ ¹æ®æŸ¥è¯¢å†…å®¹å’Œä¸šåŠ¡é¢†åŸŸåŠ¨æ€ç”Ÿæˆä¸Šä¸‹æ–‡è¯
        
        Args:
            query: åŸå§‹æŸ¥è¯¢
            domains: è¯†åˆ«çš„ä¸šåŠ¡é¢†åŸŸ
            synonyms: å·²æ‰¾åˆ°çš„åŒä¹‰è¯
            
        Returns:
            åŠ¨æ€ç”Ÿæˆçš„ä¸Šä¸‹æ–‡è¯åˆ—è¡¨
        """
        context_words = set()
        
        # åŸºç¡€ä¼ä¸šä¸Šä¸‹æ–‡
        base_context = ["äºšä¿¡æ•°å­—", "å…¬å¸", "å‘˜å·¥", "éƒ¨é—¨"]
        context_words.update(base_context)
        
        # æ ¹æ®ä¸šåŠ¡é¢†åŸŸç”Ÿæˆç‰¹å®šä¸Šä¸‹æ–‡
        domain_context_map = {
            "è¿è¥å•†äº§å“è§£å†³æ–¹æ¡ˆ": [
                "è¿è¥å•†", "ç”µä¿¡", "ç½‘ç»œ", "åŸºç«™", "5G", "æ•°å­—åŒ–è½¬å‹", 
                "é€šä¿¡ç½‘ç»œ", "ç½‘ç»œä¼˜åŒ–", "è¿ç»´æœåŠ¡", "æŠ€æœ¯æ”¯æ’‘"
            ],
            "æ”¿ä¼äº§å“è§£å†³æ–¹æ¡ˆ": [
                "æ”¿åºœ", "ä¼ä¸š", "æ•°å­—æ”¿åŠ¡", "æ™ºæ…§åŸå¸‚", "æ”¿ä¼å®¢æˆ·",
                "è¡Œä¸šè§£å†³æ–¹æ¡ˆ", "æ•°å­—åŒ–æœåŠ¡", "ä¸šåŠ¡è½¬å‹", "ä¿¡æ¯åŒ–å»ºè®¾"
            ],
            "å›½é™…äº§å“BSSè§£å†³æ–¹æ¡ˆ": [
                "å›½é™…å¸‚åœº", "æµ·å¤–å®¢æˆ·", "è®¡è´¹ç»“ç®—", "å®¢æˆ·æœåŠ¡",
                "ä¸šåŠ¡æ”¯æ’‘", "è¿è¥å•†BSS", "å…¨çƒåŒ–", "æœ¬åœ°åŒ–æœåŠ¡"
            ],
            "å›½é™…äº§å“OSSè§£å†³æ–¹æ¡ˆ": [
                "ç½‘ç»œè¿ç»´", "æµ·å¤–éƒ¨ç½²", "è¿è¥æ”¯æ’‘", "ç½‘ç»œç®¡ç†",
                "å›½é™…æ ‡å‡†", "è·¨å›½è¿è¥", "æŠ€æœ¯è¾“å‡º", "å…¨çƒæœåŠ¡"
            ],
            "è´¢åŠ¡ç®¡ç†": [
                "è´¢åŠ¡åˆè§„", "æˆæœ¬æ§åˆ¶", "é¢„ç®—ç®¡ç†", "é£é™©ç®¡æ§",
                "å†…éƒ¨å®¡è®¡", "è´¢åŠ¡æµç¨‹", "ç¨åŠ¡ç­¹åˆ’", "èµ„é‡‘ç®¡ç†"
            ],
            "æŠ€æœ¯è¿ç»´": [
                "ç³»ç»Ÿç¨³å®š", "æ€§èƒ½ä¼˜åŒ–", "å®‰å…¨é˜²æŠ¤", "æ•…éšœå¤„ç†",
                "æŠ€æœ¯åˆ›æ–°", "è¿ç»´è‡ªåŠ¨åŒ–", "ç›‘æ§å‘Šè­¦", "æŠ€æœ¯æ”¯æŒ"
            ]
        }
        
        # æ·»åŠ é¢†åŸŸç‰¹å®šä¸Šä¸‹æ–‡
        for domain in domains:
            if domain in domain_context_map:
                context_words.update(domain_context_map[domain][:6])  # æ¯ä¸ªé¢†åŸŸå–6ä¸ªè¯
        
        # æ ¹æ®äº§å“ç±»å‹ç”Ÿæˆç‰¹å®šä¸Šä¸‹æ–‡
        product_context_map = {
            # ç½‘ç»œç®¡ç†äº§å“
            "IPOSS": ["ç½‘ç»œè¿ç»´", "ç³»ç»Ÿç›‘æ§", "æ•…éšœè¯Šæ–­", "æ€§èƒ½åˆ†æ", "é…ç½®ç®¡ç†", "è‡ªåŠ¨åŒ–è¿ç»´"],
            "NMS": ["ç½‘ç»œç®¡ç†", "è®¾å¤‡ç›‘æ§", "æ‹“æ‰‘å‘ç°", "å‘Šè­¦å¤„ç†", "è¿ç»´æ•ˆç‡", "ç½‘ç»œä¼˜åŒ–"],
            "FMS": ["æ•…éšœç®¡ç†", "é—®é¢˜è¯Šæ–­", "åº”æ€¥å“åº”", "æœåŠ¡æ¢å¤", "è¿ç»´æµç¨‹", "è´¨é‡ä¿éšœ"],
            
            # ç»ˆç«¯ç®¡ç†äº§å“  
            "ITMS": ["ç»ˆç«¯ç®¡ç†", "è®¾å¤‡é…ç½®", "è¿œç¨‹æ§åˆ¶", "è½¯ä»¶åˆ†å‘", "å®‰å…¨ç­–ç•¥", "èµ„äº§ç®¡ç†"],
            "CSMP": ["å®¶åº­ç½‘å…³", "æ™ºèƒ½å®¶å±…", "ç”¨æˆ·ä½“éªŒ", "æœåŠ¡è´¨é‡", "è¿œç¨‹è¯Šæ–­", "å®¶åº­ç½‘ç»œ"],
            
            # è®¡è´¹ç³»ç»Ÿ
            "CBS": ["è®¡è´¹å‡†ç¡®", "è´¦å•ç®¡ç†", "æ”¶å…¥ä¿éšœ", "è´¢åŠ¡å¯¹è´¦", "è´¹ç‡ç®¡ç†", "å®¢æˆ·è´¦åŠ¡"],
            "CRM": ["å®¢æˆ·å…³ç³»", "æœåŠ¡ä½“éªŒ", "é”€å”®æ”¯æŒ", "å®¢æˆ·æ´å¯Ÿ", "è¥é”€æ´»åŠ¨", "å®¢æˆ·ä»·å€¼"],
            
            # æ”¿ä¼äº§å“
            "EBOSS": ["ä¼ä¸šè¿è¥", "ä¸šåŠ¡æµç¨‹", "æ•°æ®åˆ†æ", "å†³ç­–æ”¯æŒ", "æ•ˆç‡æå‡", "æ•°å­—åŒ–ç®¡ç†"],
            "ä¼è¥ç›˜": ["ä¼ä¸šè¿è¥", "ä¸šåŠ¡æµç¨‹", "æ•°æ®åˆ†æ", "å†³ç­–æ”¯æŒ", "æ•ˆç‡æå‡", "æ•°å­—åŒ–ç®¡ç†"],
            "ä¼è¥èµ¢": ["ä¼ä¸šè¿è¥", "ä¸šåŠ¡æµç¨‹", "æ•°æ®åˆ†æ", "å†³ç­–æ”¯æŒ", "æ•ˆç‡æå‡", "æ•°å­—åŒ–ç®¡ç†"],
        }
        
        # æ ¹æ®åŒä¹‰è¯ä¸­çš„äº§å“æ·»åŠ ç‰¹å®šä¸Šä¸‹æ–‡
        for synonym in synonyms:
            if synonym in product_context_map:
                context_words.update(product_context_map[synonym][:4])  # æ¯ä¸ªäº§å“å–4ä¸ªè¯
                break  # é¿å…é‡å¤æ·»åŠ ç›¸ä¼¼äº§å“çš„ä¸Šä¸‹æ–‡
        
        # æ ¹æ®æŸ¥è¯¢å…³é”®è¯ç‰¹å¾æ·»åŠ ä¸Šä¸‹æ–‡
        query_lower = query.lower()
        if any(word in query_lower for word in ["ç½‘ç®¡", "è¿ç»´", "ç®¡ç†"]):
            context_words.update(["è¿ç»´æ•ˆç‡", "ç®¡ç†è§„èŒƒ", "æœåŠ¡è´¨é‡", "æŠ€æœ¯åˆ›æ–°"])
        elif any(word in query_lower for word in ["è®¡è´¹", "ç»“ç®—", "è´¢åŠ¡"]):
            context_words.update(["æ”¶å…¥ä¿éšœ", "è´¢åŠ¡åˆè§„", "æˆæœ¬æ§åˆ¶", "ä¸šåŠ¡æ”¯æ’‘"])
        elif any(word in query_lower for word in ["å®¢æˆ·", "æœåŠ¡", "ä½“éªŒ"]):
            context_words.update(["å®¢æˆ·æ»¡æ„", "æœåŠ¡å“è´¨", "ç”¨æˆ·ä½“éªŒ", "ä»·å€¼åˆ›é€ "])
        
        # è½¬æ¢ä¸ºåˆ—è¡¨å¹¶é™åˆ¶æ•°é‡
        context_list = list(context_words)
        return context_list[:10]  # é™åˆ¶æœ€å¤š10ä¸ªä¸Šä¸‹æ–‡è¯
    
    async def expand_keywords(self, original_query: str, expansion_type: str = "comprehensive") -> Dict[str, List[str]]:
        """
        æ‰©å±•å…³é”®è¯
        
        Args:
            original_query: åŸå§‹æœç´¢å…³é”®è¯
            expansion_type: æ‰©å±•ç±»å‹ (basic/comprehensive/contextual)
            
        Returns:
            åŒ…å«æ ¸å¿ƒè¯ã€åŒä¹‰è¯ã€ç›¸å…³è¯ã€ä¸Šä¸‹æ–‡è¯çš„å­—å…¸
        """
        if not original_query.strip():
            raise ValueError("è¯·æä¾›åŸå§‹æœç´¢å…³é”®è¯")
        
        server_logger.info(f"å¼€å§‹å…³é”®è¯æ‰©å±• | åŸè¯: '{original_query}' | ç±»å‹: {expansion_type}")
        
        # æ™ºèƒ½è¯†åˆ«ä¸šåŠ¡é¢†åŸŸ
        matched_domains = self._identify_business_domains(original_query)
        
        # æ”¹è¿›çš„å…³é”®è¯å¤„ç† - æ”¯æŒå¤åˆè¯åŒ¹é…
        core_words = [word.strip() for word in original_query.split() if word.strip()]
        
        expanded_keywords = {
            "æ ¸å¿ƒè¯": core_words,
            "åŒä¹‰è¯": [],
            "ç›¸å…³è¯": [],
            "ä¸Šä¸‹æ–‡è¯": [],
            "ä¸šåŠ¡é¢†åŸŸ": matched_domains
        }
        
        # ç”ŸæˆåŒä¹‰è¯ - æ”¹è¿›åŒ¹é…é€»è¾‘
        synonyms_found = set()
        
        # 1. é¦–å…ˆå°è¯•å®Œæ•´åŒ¹é…ï¼ˆå¦‚"å…¬å¸ç¨å·"ï¼‰
        query_lower = original_query.lower()
        if query_lower in self.all_synonyms:
            synonyms_found.update(self.all_synonyms[query_lower])
            server_logger.info(f"å®Œæ•´åŒ¹é…æ‰¾åˆ°åŒä¹‰è¯: {query_lower}")
        
        # 2. ç„¶åå°è¯•åˆ†è¯åŒ¹é…
        for word in core_words:
            word_lower = word.lower()
            if word_lower in self.all_synonyms:
                synonyms_found.update(self.all_synonyms[word_lower])
                server_logger.info(f"åˆ†è¯åŒ¹é…æ‰¾åˆ°åŒä¹‰è¯: {word_lower}")
            else:
                # 3. å°è¯•åŒ…å«åŒ¹é…ï¼ˆå¦‚"ç¨å·"åŒ…å«åœ¨"å…¬å¸ç¨å·"ä¸­ï¼‰
                for synonym_key in self.all_synonyms:
                    if synonym_key in word_lower or word_lower in synonym_key:
                        synonyms_found.update(self.all_synonyms[synonym_key])
                        server_logger.info(f"åŒ…å«åŒ¹é…æ‰¾åˆ°åŒä¹‰è¯: {synonym_key} <- {word_lower}")
                        break
                
                # 4. å°è¯•ç›¸ä¼¼è¯åŒ¹é…
                for synonym_key, synonym_list in self.all_synonyms.items():
                    if self._is_similar_word(synonym_key, word_lower):
                        synonyms_found.update(synonym_list)
                        server_logger.info(f"ç›¸ä¼¼è¯åŒ¹é…æ‰¾åˆ°åŒä¹‰è¯: {synonym_key} <- {word_lower}")
                        break
        
        expanded_keywords["åŒä¹‰è¯"] = list(synonyms_found)
        
        # åŸºäºè¯†åˆ«çš„ä¸šåŠ¡é¢†åŸŸç”Ÿæˆæ‰©å±•è¯ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰
        for domain in matched_domains:
            if domain in self.domain_keywords:
                domain_data = self.domain_keywords[domain]
                domain_expansions = domain_data["æ‰©å±•è¯"]
                priority_words = domain_data.get("ä¼˜å…ˆçº§", [])
                
                # ä¼˜å…ˆçº§è¯æ±‡æ’åœ¨å‰é¢
                sorted_expansions = []
                for word in priority_words:
                    if word in domain_expansions:
                        sorted_expansions.append(word)
                
                # æ·»åŠ å…¶ä»–éä¼˜å…ˆçº§è¯æ±‡
                for word in domain_expansions:
                    if word not in priority_words:
                        sorted_expansions.append(word)
                
                expanded_keywords["ç›¸å…³è¯"].extend(sorted_expansions)
                server_logger.info(f"åŸºäºä¸šåŠ¡é¢†åŸŸ '{domain}' æ‰©å±•äº† {len(sorted_expansions)} ä¸ªç›¸å…³è¯ (ä¼˜å…ˆçº§: {len(priority_words)}ä¸ª)")
        
        # ç”Ÿæˆç›¸å…³è¯ï¼ˆåŸºäºä¸šåŠ¡åœºæ™¯ï¼‰
        for word in core_words:
            if word in self.business_contexts:
                expanded_keywords["ç›¸å…³è¯"].extend(self.business_contexts[word])
            else:
                # å°è¯•é€šè¿‡ç›¸ä¼¼è¯åŒ¹é…æ‰¾åˆ°ä¸šåŠ¡åœºæ™¯ç›¸å…³è¯
                for context_key, context_list in self.business_contexts.items():
                    if self._is_similar_word(context_key, word):
                        expanded_keywords["ç›¸å…³è¯"].extend(context_list)
                        server_logger.info(f"é€šè¿‡ç›¸ä¼¼è¯åŒ¹é…ä¸º '{word}' æ‰¾åˆ°ä¸šåŠ¡åœºæ™¯è¯ç»„: {context_key}")
                        break
        
        # ç”Ÿæˆä¸Šä¸‹æ–‡è¯ï¼ˆåŸºäºä¸šåŠ¡é¢†åŸŸå’Œäº§å“ç‰¹æ€§åŠ¨æ€ç”Ÿæˆï¼‰
        if expansion_type in ["comprehensive", "contextual"]:
            expanded_keywords["ä¸Šä¸‹æ–‡è¯"] = self._generate_dynamic_context_words(original_query, matched_domains, synonyms_found)
        
        # å»é‡å¤„ç†å¹¶æŒ‰ç›¸å…³æ€§æ’åº
        for key in expanded_keywords:
            if key in ["åŒä¹‰è¯", "ç›¸å…³è¯"]:  # å¯¹åŒä¹‰è¯å’Œç›¸å…³è¯è¿›è¡Œæ™ºèƒ½æ’åº
                # å…ˆå»é‡
                unique_words = list(set(expanded_keywords[key]))
                # æŒ‰ç›¸å…³æ€§æ’åº
                expanded_keywords[key] = self._sort_expanded_words(unique_words, original_query)
                server_logger.info(f"{key}æŒ‰ç›¸å…³æ€§æ’åºå®Œæˆï¼Œå…±{len(expanded_keywords[key])}ä¸ªè¯")
            else:
                # å…¶ä»–ç±»å‹åªå»é‡
                expanded_keywords[key] = list(set(expanded_keywords[key]))
        
        server_logger.info(f"å…³é”®è¯æ‰©å±•å®Œæˆ | æ€»è¯æ•°: {sum(len(v) for v in expanded_keywords.values())}")
        
        return expanded_keywords
    
    def format_expansion_result(self, original_query: str, expanded_keywords: Dict[str, List[str]], expansion_type: str) -> str:
        """
        æ ¼å¼åŒ–æ‰©å±•ç»“æœ
        
        Args:
            original_query: åŸå§‹æŸ¥è¯¢
            expanded_keywords: æ‰©å±•å…³é”®è¯å­—å…¸
            expansion_type: æ‰©å±•ç±»å‹
            
        Returns:
            æ ¼å¼åŒ–çš„æ‰©å±•ç»“æœå­—ç¬¦ä¸²
        """
        core_words = expanded_keywords["æ ¸å¿ƒè¯"]
        
        # ä¸šåŠ¡é¢†åŸŸä¿¡æ¯
        domain_info = ""
        if expanded_keywords.get("ä¸šåŠ¡é¢†åŸŸ"):
            domain_info = f"""
ğŸ¢ **è¯†åˆ«ä¸šåŠ¡é¢†åŸŸ** ({len(expanded_keywords['ä¸šåŠ¡é¢†åŸŸ'])}ä¸ª):
{' | '.join(expanded_keywords['ä¸šåŠ¡é¢†åŸŸ'])}
"""
        
        result = f"""
ğŸ¯ å…³é”®è¯æ™ºèƒ½æ‰©å±•ç»“æœ

ğŸ“ åŸå§‹æŸ¥è¯¢: "{original_query}"
ğŸ”§ æ‰©å±•ç±»å‹: {expansion_type}{domain_info}

ğŸ“Š æ‰©å±•å…³é”®è¯:

ğŸ¯ **æ ¸å¿ƒè¯** ({len(expanded_keywords['æ ¸å¿ƒè¯'])}ä¸ª):
{' | '.join(expanded_keywords['æ ¸å¿ƒè¯'])}

ğŸ”„ **åŒä¹‰è¯** ({len(expanded_keywords['åŒä¹‰è¯'])}ä¸ª):
{' | '.join(expanded_keywords['åŒä¹‰è¯']) if expanded_keywords['åŒä¹‰è¯'] else 'æš‚æ— '}

ğŸ”— **ç›¸å…³è¯** ({len(expanded_keywords['ç›¸å…³è¯'])}ä¸ª):
{' | '.join(expanded_keywords['ç›¸å…³è¯']) if expanded_keywords['ç›¸å…³è¯'] else 'æš‚æ— '}

ğŸŒ **ä¸Šä¸‹æ–‡è¯** ({len(expanded_keywords['ä¸Šä¸‹æ–‡è¯'])}ä¸ª):
{' | '.join(expanded_keywords['ä¸Šä¸‹æ–‡è¯']) if expanded_keywords['ä¸Šä¸‹æ–‡è¯'] else 'æš‚æ— '}

ğŸ’¡ **å»ºè®®æœç´¢ç­–ç•¥**:
1. ç¬¬1è½®: ä½¿ç”¨æ ¸å¿ƒè¯è¿›è¡Œç²¾å‡†æœç´¢
2. ç¬¬2è½®: ç»“åˆåŒä¹‰è¯æ‰©å¤§æœç´¢èŒƒå›´  
3. ç¬¬3è½®: åŠ å…¥ç›¸å…³è¯è¿›è¡Œå…³è”æœç´¢
4. ç¬¬4è½®: ä½¿ç”¨ä¸Šä¸‹æ–‡è¯è¿›è¡Œå…¨é¢æ£€ç´¢

ğŸ” **æ¨èæœç´¢ç»„åˆ**:
â€¢ ç²¾å‡†æœç´¢: {' '.join(core_words[:3])}
â€¢ æ‰©å±•æœç´¢: {' '.join((expanded_keywords['ç›¸å…³è¯'][:2] + expanded_keywords['æ ¸å¿ƒè¯'] + expanded_keywords['åŒä¹‰è¯'])[:5])}
â€¢ å…¨é¢æœç´¢: {' '.join((expanded_keywords['ç›¸å…³è¯'][:4] + expanded_keywords['æ ¸å¿ƒè¯'] + expanded_keywords['åŒä¹‰è¯'])[:8])}
"""
        
        return result 

    def _calculate_word_relevance(self, word: str, original_query: str) -> int:
        """
        è®¡ç®—è¯æ±‡ä¸åŸå§‹æŸ¥è¯¢çš„ç›¸å…³æ€§åˆ†æ•°
        
        Args:
            word: å¾…è¯„åˆ†çš„è¯æ±‡
            original_query: åŸå§‹æŸ¥è¯¢
            
        Returns:
            ç›¸å…³æ€§åˆ†æ•° (åˆ†æ•°è¶Šé«˜è¶Šç›¸å…³)
        """
        score = 0
        query_lower = original_query.lower()
        word_lower = word.lower()
        
        # 1. ç›´æ¥åŒ…å«å…³ç³» (æœ€é«˜åˆ†)
        if word_lower in query_lower:
            score += 100
        
        # 2. æŸ¥è¯¢è¯åœ¨æ‰©å±•è¯ä¸­çš„åŒ…å«å…³ç³»
        query_words = [w.strip().lower() for w in original_query.split() if w.strip()]
        for query_word in query_words:
            if query_word in word_lower:
                score += 80
        
        # 3. ç¨å·ç›¸å…³çš„ç‰¹æ®Šé«˜æƒé‡å¤„ç†
        tax_related_queries = ["ç¨å·", "çº³ç¨äºº", "å…¬å¸ç¨å·", "çº³ç¨äººè¯†åˆ«å·", "ç¨åŠ¡ç™»è®°"]
        finance_core_words = ["è´¢åŠ¡", "ç¨åŠ¡"]
        
        for tax_query in tax_related_queries:
            if tax_query in query_lower:
                if word_lower in finance_core_words:
                    score += 200  # ç»™äºˆè´¢åŠ¡ã€ç¨åŠ¡æœ€é«˜æƒé‡
                    server_logger.info(f"ç¨å·æŸ¥è¯¢ '{tax_query}' åŒ¹é…è´¢åŠ¡æ ¸å¿ƒè¯ '{word}', é«˜æƒé‡: +200")
        
        # 4. é€šè¿‡åŒä¹‰è¯å­—å…¸çš„å…³è”åº¦
        for query_word in query_words:
            for synonym_key, synonym_list in self.all_synonyms.items():
                if query_word == synonym_key.lower():
                    # å¦‚æœæŸ¥è¯¢è¯æ˜¯åŒä¹‰è¯ç»„çš„é”®ï¼Œè¯¥ç»„å†…çš„è¯å¾—é«˜åˆ†
                    if word in synonym_list:
                        score += 60
                elif query_word in [s.lower() for s in synonym_list]:
                    # å¦‚æœæŸ¥è¯¢è¯åœ¨åŒä¹‰è¯åˆ—è¡¨ä¸­ï¼ŒåŒç»„å…¶ä»–è¯å¾—åˆ†
                    if word == synonym_key or word in synonym_list:
                        score += 50
        
        # 5. é€šè¿‡ç›¸ä¼¼è¯æ˜ å°„çš„å…³è”åº¦ - å¢å¼ºç¨å·ã€çº³ç¨äººçš„å…³è”
        similarity_map = {
            "ç¨åŠ¡": ["ç¨æ”¶", "çº³ç¨", "å¾ç¨", "ç¨æ³•", "ç¨å·", "çº³ç¨äºº", "çº³ç¨äººè¯†åˆ«å·"],
            "è´¢åŠ¡": ["è´¢æ”¿", "èµ„é‡‘", "é‡‘è", "ç¨å·", "çº³ç¨äºº", "ç¨åŠ¡ç™»è®°", "çº³ç¨äººè¯†åˆ«å·"],
            "åˆ¶åº¦": ["æ”¿ç­–", "è§„å®š", "æ³•è§„"],
            "ç®¡ç†": ["ç›‘ç®¡", "æ²»ç†", "æ§åˆ¶"],
            "å®¡è®¡": ["å®¡æ ¸", "æ ¸æŸ¥", "æ£€æŸ¥"],
            "æ”¿ç­–": ["åˆ¶åº¦", "è§„å®š", "åŠæ³•"],
            "ç¨å·": ["çº³ç¨äººè¯†åˆ«å·", "ç¨åŠ¡ç™»è®°å·", "è´¢åŠ¡", "ç¨åŠ¡", "çº³ç¨äºº"],
            "çº³ç¨äºº": ["ç¨å·", "çº³ç¨äººè¯†åˆ«å·", "è´¢åŠ¡", "ç¨åŠ¡", "ä¼ä¸š", "ç¨åŠ¡ç™»è®°"],
            "çº³ç¨äººè¯†åˆ«å·": ["ç¨å·", "çº³ç¨äºº", "è´¢åŠ¡", "ç¨åŠ¡", "ç¨åŠ¡ç™»è®°å·"],
            "è½¯è‘—": ["è½¯ä»¶è‘—ä½œæƒ", "ç‰ˆæƒ", "çŸ¥è¯†äº§æƒ", "ä¸“åˆ©"],
            "æŠ¥é”€": ["è´¹ç”¨", "æ”¯å‡º", "è´¢åŠ¡", "ç”³è¯·", "å®¡æ‰¹", "æµç¨‹"]
        }
        
        # åˆå¹¶äº§å“æœ¯è¯­ç›¸ä¼¼è¯æ˜ å°„è¿›è¡Œæƒé‡è®¡ç®—
        combined_similarity_map = {**similarity_map, **self.product_similarity_map}
        
        for query_word in query_words:
            for key, similar_words in combined_similarity_map.items():
                if query_word == key.lower() or key in query_word:
                    if word.lower() in [s.lower() for s in similar_words]:
                        # äº§å“æœ¯è¯­ç»™äºˆæ›´é«˜æƒé‡
                        if key in self.product_similarity_map:
                            score += 60  # äº§å“æœ¯è¯­ç›¸å…³æ€§æ›´é«˜
                        else:
                            score += 40
                elif query_word in [s.lower() for s in similar_words]:
                    if word.lower() == key.lower():
                        # äº§å“æœ¯è¯­ç»™äºˆæ›´é«˜æƒé‡
                        if key in self.product_similarity_map:
                            score += 60  # äº§å“æœ¯è¯­ç›¸å…³æ€§æ›´é«˜
                        else:
                            score += 40
        
        # 6. é€šè¿‡ä¸šåŠ¡åœºæ™¯è¯å…¸çš„å…³è”åº¦
        for query_word in query_words:
            for context_key, context_words in self.business_contexts.items():
                # ç›´æ¥åŒ¹é…ä¸šåŠ¡åœºæ™¯é”®
                if query_word == context_key.lower() or context_key in query_word:
                    if word in context_words:
                        score += 50
                # é€šè¿‡ç›¸ä¼¼è¯åŒ¹é…ä¸šåŠ¡åœºæ™¯é”®  
                elif self._is_similar_word(context_key, query_word):
                    if word in context_words:
                        score += 45
        
        return score
    
    def _sort_expanded_words(self, words: List[str], original_query: str) -> List[str]:
        """
        æ ¹æ®ç›¸å…³æ€§å¯¹æ‰©å±•è¯è¿›è¡Œæ’åº
        
        Args:
            words: æ‰©å±•è¯åˆ—è¡¨
            original_query: åŸå§‹æŸ¥è¯¢
            
        Returns:
            æ’åºåçš„æ‰©å±•è¯åˆ—è¡¨
        """
        if not words:
            return words
        
        # è®¡ç®—æ¯ä¸ªè¯çš„ç›¸å…³æ€§åˆ†æ•°å¹¶æ’åº
        word_scores = [(word, self._calculate_word_relevance(word, original_query)) for word in words]
        word_scores.sort(key=lambda x: x[1], reverse=True)
        
        sorted_words = [word for word, score in word_scores]
        
        server_logger.info(f"æ‰©å±•è¯ç›¸å…³æ€§æ’åº: {[(w, s) for w, s in word_scores[:5]]}")  # è®°å½•å‰5ä¸ªçš„åˆ†æ•°
        
        return sorted_words 